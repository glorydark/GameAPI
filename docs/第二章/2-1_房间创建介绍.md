# 2.0 GameAPI基本操作概述

## 简单介绍
在GameAPI小游戏中，一个小游戏包含以下的几部分：
- 房间
  - 读取并生成
  - 投入使用
- 指令
- 菜单操作
- 事件监听器（干了什么事，就执行什么操作）
- ...

## 房间读取
当我们想要创建一个房间，以上的流程是大多数开发者需要经历的。
我们需要设置游戏时间、房间的游戏世界、出生点...

### 房间对象创建
首先，创建一个房间，我们可以通过此构造器，创建一个新的房间对象。
```java
// 房间构造类，gameName为游戏名，roomRule为房间规则，playLevels为游戏世界（可多个），roomLevelBackup房间备份，round游戏回合
public Room(String gameName, RoomRule roomRule, List<Level> playLevels, String roomLevelBackup, int round)
```
### 设置房间为临时房间
想要设置房间为临时房间（即不重置地图，用完即销毁）？这就奉上：
```java
room.setTemporary(true);
```
房间默认为普通房间，需要设置此功能，临时房间的roomLevelBackup可为空。

[!] 当然，普通房间的roomLevelBackup也可为空，但请记得room.setResetMap(false)喔！
### 房间名称
```java
String backup = (String) config.get("LoadWorld");
// 设置房间备份地图，此地图应该放在GameAPI/worlds下
// room.setRoomLevelBackup(backup);
// 此处无需设置，因为这个房间是临时房间
String newName = room.getGameName() + "_" + backup + "_" + UUID.randomUUID();
// 设置房间名
room.setRoomName(newName);
```
临时房间的名称建议开发者自行设置，或由核心内部自行分配房间名称（游戏名_数字id）。
以上的方法也可以做一个参照，UUID来使房间名几乎独一无二。
### 房间地图
```java
if (WorldTools.loadLevelFromBackup(newName, backup)){
    // 设置游戏世界（必须设置）
    room.addPlayLevel(Server.getInstance().getLevelByName(newName));
    this.getLogger().info("Room 【"+backup+"】 loaded！");
}
```
通过WorldTools.loadLevelFromBackup(加载名称, 备份地图名)，你可以直接加载plugins/GameAPI/worlds/下的地图。
通过room.addPlayLevel(Level level)我们可以添加游戏地图，一个房间最少需要一张地图！

什么，单房间多地图？可以的，但是看你怎么用了！

当然，游戏地图记得务必通过此方法添加，以方便在游戏结束进行卸载、重置操作（如果是普通房间且需要重置地图）
### 房间各种位置
```java
// 位置字符串格式: x:y:z:level:yaw:pitch:headyaw，后三者可省略
room.setWaitSpawn(String string); // 游戏等待出生点
room.addStartSpawn(String string); // 游戏开始出生点
room.addEndSpawn(String string); // 游戏结束返回位置
room.addSpectatorSpawn(String string); // 观察者出生点
// 以上的各个坐标，如不进行添加，则不进行传送操作
// 除房间结束会默认将玩家传回服务器默认出生点外!!!
```
### 房间最大/最小人数
```
room.setMinPlayer(2);
room.setMaxPlayer(16);
```
### 胜利失败指令，自带玩家变量%player%
```java
room.setWinConsoleCommands((List<String>) config.getOrDefault("WinCommands", new ArrayList<>()));
room.setLoseConsoleCommands((List<String>) config.getOrDefault("FailedCommands", new ArrayList<>()));
```
### 最后一步：加载房间
```java
// 加载房间，到此处房间加载正式完成！
RoomManager.loadRoom(room, RoomStatus.ROOM_STATUS_WAIT);
```
### 如果要保存一些特殊数据到房间内呢？
可以使用room.setRoomProperty(String key, Object value)

如果是保存玩家临时数据，可以使用room.setPlayerProperty(Player player, String key, Object value)

但请注意，游戏结束后（RoomEndEvent触发时），房间会进行重置，玩家临时数据将会清空！
## 实际案例
下面是摘自示例小游戏[SimplePVPGame](https://github.com/glorydark/GameAPI_Example/blob/main/SimplePVPGame/src/main/java/glorydark/pvp/MainClass.java)的一段创建并加载临时房间的代码！
```java
public Room loadRoom(String map) {
    // 设置房间规则
    RoomRule roomRule = new RoomRule(0);
    roomRule.setAllowDamagePlayer(true);
    roomRule.setNoTimeLimit(true);
    // 创建房间变量，playLevel设为null是为了方便下面进行设置
    Room room = new Room("PvpGame", roomRule, new ArrayList<>(), "", 1);
    // 设置房间为临时房间，这样房间就不会自动加载地图备份了
    room.setTemporary(true);
    Map<String, Object> config = (Map<String, Object>) mapConfigs.getOrDefault(map, new HashMap<>());
    if (config.containsKey("LoadWorld")) {
        String backup = (String) config.get("LoadWorld");
        // 设置房间备份地图，此地图应该放在GameAPI/worlds下
        // room.setRoomLevelBackup(backup);
        // 此处无需设置，因为这个房间是临时房间
        String newName = room.getGameName() + "_" + backup + "_" + UUID.randomUUID();
        // 设置房间名
        room.setRoomName(newName);
        // 从备份处加载地图，此地图应该放在GameAPI/worlds下
        if (WorldTools.loadLevelFromBackup(newName, backup)) {
            // 设置游戏世界（必须设置）
            room.addPlayLevel(Server.getInstance().getLevelByName(newName));
            this.getLogger().info("Room 【" + backup + "】 loaded！");

            // 下面是加载出生点配置，这些配置如果出错则会报错，返回null值。
            if (config.containsKey("WaitSpawn")) {
                room.setWaitSpawn(((String) config.get("WaitSpawn")).replace(backup, newName));
            } else {
                this.getLogger().error("Failed to load the room " + map + ", caused by the wrong format in WaitSpawn Configuration!");
                return null;
            }

            if (config.containsKey("StartSpawn")) {
                room.addStartSpawn(((String) config.get("StartSpawn")).replace(backup, newName));
            } else {
                this.getLogger().error("Failed to load the room " + map + ", caused by the wrong format in StartSpawn Configuration!");
                return null;
            }

            // 下面是加载等待时间、游戏最大时间，这些配置如果出错则会报错，返回null值。
            if (config.containsKey("WaitTime")) {
                room.setWaitTime((int) config.get("WaitTime"));
            } else {
                this.getLogger().error("Failed to load the room " + map + ", caused by the wrong format in WaitTime Configuration!");
                return null;
            }

            if (config.containsKey("GameTime")) {
                room.setGameTime((int) config.get("GameTime"));
            } else {
                this.getLogger().error("Failed to load the room " + map + ", caused by the wrong format in GameTime Configuration!");
                return null;
            }

            // 设置房间最大最小人数
            room.setMinPlayer(2);
            room.setMaxPlayer(2);

            // 设置默认返回地点为服务器默认出生点
            room.setEndSpawn(Server.getInstance().getDefaultLevel().getSpawnLocation().getLocation());

            // 设置胜利、失败指令，自带%player%变量
            room.setWinConsoleCommands((List<String>) config.getOrDefault("WinCommands", new ArrayList<>()));
            room.setLoseConsoleCommands((List<String>) config.getOrDefault("FailedCommands", new ArrayList<>()));

            // 加载房间，到此处房间加载正式完成！
            RoomManager.loadRoom(room, RoomStatus.ROOM_STATUS_WAIT);
            this.getLogger().info("Room " + map + " loaded successfully!");
            return room;
        } else {
            this.getLogger().error("Failed to copy the map!");
        }
    } else {
        this.getLogger().error("Failed to load the room, caused by: MapNotFoundException");
    }
    return null;
}
```